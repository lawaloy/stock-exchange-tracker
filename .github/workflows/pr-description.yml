name: PR Description

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  update-description:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate PR description
        run: |
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          git fetch origin $BASE_REF

          # Get commit messages (summary)
          COMMITS=$(git log --format="- %s" origin/$BASE_REF..HEAD)
          [ -z "$COMMITS" ] && COMMITS="- (no new commits)"

          # Get changed files
          FILES=$(git diff --name-only origin/$BASE_REF...HEAD | sed 's/^/- `/' | sed 's/$/`/')
          [ -z "$FILES" ] && FILES="- (no files changed)"

          {
            echo "## Summary"
            echo ""
            echo "$COMMITS"
            echo ""
            echo "## Files changed"
            echo ""
            echo "$FILES"
          } > pr-body.md

      - name: Update PR description
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const MAX_LENGTH = 65536;
            const TRUNCATE_SUFFIX = '\n\n... (truncated)';

            let body = fs.readFileSync('pr-body.md', 'utf8');

            if (body.length > MAX_LENGTH) {
              // Prefer: keep full summary, truncate files section only
              const filesHeader = '## Files changed';
              const idx = body.indexOf(filesHeader);
              if (idx !== -1) {
                const summaryPart = body.slice(0, idx + filesHeader.length + 2);
                const maxFilesLen = MAX_LENGTH - summaryPart.length - TRUNCATE_SUFFIX.length;
                const filesPart = body.slice(idx + filesHeader.length + 2);
                body = summaryPart + (maxFilesLen > 0 ? filesPart.slice(0, maxFilesLen) : '') + TRUNCATE_SUFFIX;
              }
              // Fallback: if summary alone exceeds limit, truncate from end
              if (body.length > MAX_LENGTH) {
                body = body.slice(0, MAX_LENGTH - TRUNCATE_SUFFIX.length) + TRUNCATE_SUFFIX;
              }
            }

            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            await github.rest.pulls.update({
              owner,
              repo,
              pull_number: prNumber,
              body
            });
